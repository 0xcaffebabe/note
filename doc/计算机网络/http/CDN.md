# CDN

>CDN加速意思就是在用户和我们的服务器之间加一个缓存机制,动态获取IP地址根据地理位置，让用户到最近的服务器访问

![屏幕截图 2020-09-27 113806](/assets/屏幕截图%202020-09-27%20113806.png)

## 原理

1) 用户向浏览器提供要访问的域名；

2) **路由解析**：浏览器调用域名解析库对域名进行解析，由于CDN对域名解析过程进行了调整，所以解析函数库一般得到的是该域名对应的CNAME记录（CDN地址），为了得到实际IP地址，浏览器需要再次对获得的CNAME进行解析以得到实际的IP地址；在此过程中，使用的全局负载均衡DNS解析，如根据地理位置信息解析对应的IP地址，使得用户能就近访问；

3) 此次解析得到CDN缓存服务器的IP地址，浏览器在得到实际的IP地址以后，向缓存服务器发出访问请求

4) 缓存服务器根据浏览器提供的要访问的域名，通过Cache内部专用DNS解析得到此域名的实际IP地址，再由缓存服务器向此实际IP地址提交访问请求

5) 缓存服务器从实际IP地址得得到内容以后，一方面在本地进行保存，以备以后使用，二方面把获取的数据返回给客户端，完成数据服务过程

6) 客户端得到由缓存服务器返回的数据以后显示出来并完成整个浏览的数据请求过程

## 路由解析

![路由解析](/assets/屏幕截图%202021-12-21%20101329.png)

## 内容分发

缓存节点中必须有用户想要请求的资源副本，那么这些节点资源时如何获取以及存储的？

- 主动分发：也被称为预热，分发由源站主动发起，将内容从源站或者其他资源库推送到用户边缘的各个CDN缓存节点上 这种分发不仅可以从源站分发到CDN节点 甚至能提前分发到用户浏览器 降低高峰时期压力
- 被动回源：CDN缓存节点发现自己没有该资源，就会实时从源站中获取

对于资源的管理，一般分为主动失效与被动失效：

- 被动失效：一段时间后资源过期，需要重新回源
- 主动失效：某些事件强行使资源失效

## CDN 动态加速

通过动态的链路探测来寻找回源最好的一条路径

![屏幕截图 2020-09-27 114519](/assets/屏幕截图%202020-09-27%20114519.png)

## CDN应用

- 加速
- 协议升级 源站http 对外https...
- 访问控制 基础DDos防御
- 修改资源 功能注入

## CDN容灾

- CDN一挂 业务就会受到极大影响甚至停摆

![美团CDN容灾方案](/assets/2022114155034.png)
![美团CDN容灾流程](/assets/20221141699.png)

### 目标

- 终端CDN域名自动切换
- CDN域名之间隔离
- CDN监控
- 不同的CDN持续热备

### 端侧实现

#### Web端实现

传统的标签资源如css img等通过监听失败回调实现

而js脚本则需要统一使用动态加载的方式

#### Native端实现

- 适配多种http框架
- 使用统一拦截

#### 域名动态计算

域名A -> 请求失败 -> 域名B -> 请求失败 -> 域名C
