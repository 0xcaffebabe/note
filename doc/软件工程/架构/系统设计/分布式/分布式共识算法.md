---
tags: ['分布式', '共识算法', '分布式理论', '一致性', 'cap定理']
---
# 分布式共识算法

> * 共识究竟是什么问题
> * 不同算法解决的是哪一类共识
> * 为什么这些设计在工程上是“必然的”

---

## 一、第一性原理：什么是分布式共识

### 1. 共识要解决的根本问题

**分布式共识（Distributed Consensus）**的本质是：

> 在不可靠网络、节点可能失效甚至作恶的前提下，
> 多个节点必须对**同一对象**，在**同一逻辑顺序**上，
> 做出**相同且不可撤销的决定**。

这一定义刻意回避了具体算法，实现的是**问题层抽象**。

---

### 2. 共识的三个不可回避的现实约束

所有共识算法都隐含接受以下现实：

1. **网络不可靠**：消息可能延迟、乱序、丢失
2. **节点可能失败**：宕机、重启、永久丢失
3. **系统必须对外并发服务**：不存在全局锁

> 共识算法的复杂性，来自于在以上前提下仍要保证“统一决定”。

---

### 3. 共识对象的区分（极其关键）

很多“共识算法混淆”源于**没有区分共识对象**。

| 共识对象 | 说明            | 典型算法       |
| ---- | ------------- | ---------- |
| 单一值  | 对某个值是否被接受达成一致 | Paxos      |
| 日志序列 | 对操作顺序达成一致     | Raft / ZAB |
| 状态机  | 对状态演进过程一致     | 复制状态机      |
| 事务结果 | 对一次事务成功/失败一致  | 2PC / TCC  |
| 账本顺序 | 对不可篡改历史一致     | PoW / PBFT |

> **算法不可横向对比，除非它们的共识对象相同。**

---

## 二、共识问题的系统分类（稳定知识）

### 1. 是否存在恶意节点（根本分水岭）

```text
分布式共识问题
├── 崩溃容错（Crash Fault）
│   ├── 强一致（线性一致）
│   │   ├── Paxos
│   │   ├── Multi-Paxos / ZAB
│   │   └── Raft
│   └── 最终一致
│       ├── Gossip
│       └── Quorum NWR
└── 拜占庭容错（Byzantine Fault）
    ├── 小规模、许可系统：PBFT
    └── 大规模、开放系统：PoW
```

> **是否假设节点诚实，决定了算法复杂度的数量级差异。**

---

### 2. 一致性模型不是“强 / 弱”二分

一致性本质上是：**对外可观察行为的约束强度**。

* 强一致：对外表现为单机顺序系统
* 最终一致：短期不一致，长期收敛

算法只是**实现一致性的手段**，不是一致性本身。

---

## 三、共识算法的通用架构模式（不变思想）

从所有算法中，可以提炼出以下**稳定设计模式**。

### 1. Quorum（多数派）模式

> 用**集合重叠**替代全体一致。

* 写入只需超过半数
* 任意两次多数派必然有交集
* 交集节点承担“记忆一致性”责任

这是 Paxos、Raft、NWR 的共同根基。

---

### 2. Leader 模式（性能优化而非安全必需）

* Leader 并不是为了“正确性”
* 而是为了减少并发提议带来的冲突

> **Leader = 用局部中心化换整体吞吐**

Multi-Paxos、Raft、ZAB 本质一致。

---

### 3. 编号 / 任期（逻辑时间）

在没有全局时钟的系统中：

* 任期（term）
* 提案编号（proposal id）

承担的是：

> **事件先后关系的判定工具**

---

### 4. 日志前缀一致性（安全性的真正来源）

> 所有复制状态机安全性，都建立在：
> **已提交日志永不回滚** 之上。

Raft 的日志匹配原则、Paxos 的提案不可逆，
都是这一思想的不同表达。

---

### 5. 超时驱动（对不可靠网络的妥协）

* 选主依赖超时
* 故障检测依赖超时

> 共识算法**无法区分“慢节点”和“失效节点”**，只能赌概率。

---

## 四、经典算法的本质解读（去实现化）

### 1. Paxos：最小一致性原语

**解决的问题：**

> 多个提议者，对一个值达成唯一决定。

**核心思想：**

* 提案编号全序
* 接受者只向未来承诺

Paxos 是：

> **所有强一致算法的“原子模型”**

但工程上难以直接使用。

---

### 2. Multi-Paxos / ZAB：把一次共识变成序列共识

关键演进：

* 引入 Leader
* 一次选主，多次提交

本质变化：

> **从“值一致”升级为“日志一致”**

---

### 3. Raft：工程可理解性的胜利

Raft 并未引入新理论，而是：

* 显式状态机
* 显式任期
* 显式日志安全规则

> Raft 的价值不在于更强，而在于**可被正确实现**。

---

### 4. Gossip：接受不一致，换取规模与可用性

* 无 Leader
* 无全局顺序
* 概率收敛

适用前提：

> **业务可容忍短期不一致**

---

### 5. Quorum NWR：一致性是“读写策略”的结果

* W + R > N ⇒ 强一致（对客户端）
* W + R ≤ N ⇒ 最终一致

一致性并非算法属性，而是**策略组合的结果**。

---

### 6. PBFT / PoW：当节点不可信

**PBFT：**

* 小规模
* 已知成员
* 高通信复杂度

**PoW：**

* 开放系统
* 用经济成本替代信任

> 拜占庭共识的本质，是**信任模型的改变**。

---

## 五、选型方法论（可复用）

| 约束条件       | 推荐方向       |
| ---------- | ---------- |
| 小规模、强一致    | Raft       |
| 高吞吐、可容忍不一致 | Gossip     |
| 不可信节点      | PBFT / PoW |
| 分布式事务      | TCC        |

---

## 六、共识的根本局限（无法被算法消除）

* 节点规模固定或受限
* 强依赖超时与网络假设
* CAP 不可突破

> 共识不是银弹，而是**代价明确的工程选择**。

## 关联内容（自动生成）

- [/软件工程/架构/系统设计/分布式/分布式理论.md](/软件工程/架构/系统设计/分布式/分布式理论.md) 深入探讨了CAP定理、BASE理论等分布式系统的基本理论，与共识算法的选择和设计密切相关
- [/软件工程/架构/系统设计/分布式/分布式一致性与协调机制.md](/软件工程/架构/系统设计/分布式/分布式一致性与协调机制.md) 详细分析了分布式系统中的一致性问题和协调机制，与共识算法的实现目标一致
- [/软件工程/架构/系统设计/分布式/分布式一致性系统.md](/软件工程/架构/系统设计/分布式/分布式一致性系统.md) 探讨了分布式一致性系统的本质和实现，与共识算法的理论基础和应用场景相关
- [/中间件/数据库/分布式数据库.md](/中间件/数据库/分布式数据库.md) 分布式数据库系统是共识算法的重要应用场景，文档中涉及Raft、Paxos等算法在数据库中的应用
- [/软件工程/架构/系统设计/分布式/分布式数据.md](/软件工程/架构/系统设计/分布式/分布式数据.md) 分布式数据管理中涉及一致性、复制和共识问题，与共识算法直接相关
- [/运维/K8s.md](/运维/K8s.md) Kubernetes集群使用Raft算法保证集群状态一致性，是共识算法在实际系统中的应用
- [/数据技术/任务调度系统.md](/数据技术/任务调度系统.md) 任务调度系统中的状态一致性管理需要使用分布式共识协议，如Raft/etcd
- [/中间件/数据库/redis/哨兵.md](/中间件/数据库/redis/哨兵.md) Redis哨兵系统涉及分布式一致性问题和领导者选举，与共识算法相关
- [/中间件/数据库/redis/集群.md](/中间件/数据库/redis/集群.md) Redis Cluster使用Gossip协议进行节点间通信，是分布式共识的一种形式
- [/软件工程/微服务/ServiceMesh/ServiceMesh.md](/软件工程/微服务/ServiceMesh/ServiceMesh.md) Service Mesh控制平面需要处理分布式一致性问题，与Raft、Paxos等算法相关
- [/软件工程/架构/系统设计/分布式/分布式事务.md](/软件工程/架构/系统设计/分布式/分布式事务.md) 分布式事务处理与共识算法在解决分布式系统一致性问题上有相似之处
- [/数据技术/数据网格.md](/数据技术/数据网格.md) 数据网格的联邦治理机制与分布式共识算法在实现分布式系统一致性方面有相似之处
- [/软件工程/设计模式/设计模式.md](/软件工程/设计模式/设计模式.md) 分布式系统中的共识算法体现了特定的设计模式和架构思想
- [/算法与数据结构/算法策略.md](/算法与数据结构/算法策略.md) 分布式算法是算法策略在分布式系统中的延伸，与共识算法的设计思想相关
- [/操作系统/多处理机系统.md](/操作系统/多处理机系统.md) 多处理机系统中的缓存一致性问题与分布式共识算法在解决一致性问题上有相似之处
