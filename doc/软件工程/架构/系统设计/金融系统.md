
# 金融系统

## 金融业务

- 交易类
- 信贷类

### 系统特点

#### 场内交易

- 一级市场：公司股东之间的私下交易，信息不对称，靠人脉，实时性要求不高
- 二级市场：公开交易市场能发现合理的价格信息，对信息系统有很高的要求，低延时，高吞吐，为了实现这两个目标，开发一般都使用C和FPGA等硬件，谁的系统速度快，谁就更有可能发现赚钱的先机

#### 场外交易

绝大部分的金融交易都发生在交易所外，也叫场外交易

金融资产一旦被资产证券化，也属于场外交易

在场外交易的时候没法被动地发现价格，那么就只能主动发现价格了。所以对于场外交易的金融产品来说，你需要独立计算出合同的价格

#### 信贷类

- 传统信贷类：将利息低买高卖，交易频率低，实时性要求不高
- 资产证券化：将贷款再打包出售，所以贷款违约率就是数学上的概率，在计算风险时，不仅计算复杂，数据量也很大

### C端支付业务

#### 鉴权

```mermaid
sequenceDiagram
  买家 ->> 三方支付公司: 姓名|身份证|卡号|手机号
  三方支付公司 ->> 买家开户行: 姓名|身份证|卡号|手机号
  买家开户行 ->> 买家: 验证码
  买家 ->> 三方支付公司: 验证码
  三方支付公司 ->> 买家开户行: 验证码
  买家开户行 ->> 三方支付公司: token
  三方支付公司 ->> 买家开户行: 拿着token进行所有合法的操作
```

#### 拉取支付状态

```mermaid
stateDiagram-v2
  direction LR
  买家 --> 三方支付公司: 定时拉取状态
  三方支付公司 --> 买家: 通知支付状态
  买家开户行 --> 买家: 通知支付状态
```

#### 跨行本币代收/代付

- 存款准备金：在这个新的第三方机构里放足够多的钱，两家银行之间需要转账的时候，第三方机构在内部搬运一下就好
- 央行：信用级别最高的金融机构就是国家的中央银行，解决了真实资金的转移问题
- 轧差：在白天只做记录，不进行任何实质性的跨行转账。等每天结束的时候计算一下两个银行之间交易金额的差额是多少，最后通过央行进行一笔跨行转账
- 清算机构：记录白天跨行转账细节和晚上进行交易轧差的第三方机构，银联及网联，以及国外的万事达都是清算机构

![2022122515713](/assets/2022122515713.webp)

#### 汇总

外汇做市商，一般是巨型的跨国商业银行，跨国商业银行有不同国家的大量储户，手上就拥有不同币种的巨额存款，做市商之间通过交换不同币种的大额固定利息存折来实现外汇交易，但为了对冲外汇市场可能会有的波动导致的账面亏损，机构都会处理外汇相关的市场风险，比如用期货、期权等衍生品来对冲风险

![2022122515933](/assets/2022122515933.webp)

### C端支付核心组件

信息流与资金流分离，资金使用权的转移过程就是信息流，资金所有权的转移过程就是资金流

![2022122515279](/assets/2022122515279.webp)

- 实时清算：如果资金流和信息流不分离，可以实时保证信息流和资金流一致，但对软件系统的吞吐量和延时要求非常高，同时还要求所有参与的支付公司都具有实时清结算能力

支付环节的非银行参与者只能产生信息流，不能产生资金流

资金流和信息流分开之后，这两者将以不同速度在不同时间的不同主体分开流转，这意味着支付系统从本质上是一个异步处理系统，资金流和信息流的统一具有最终一致性

资金流和信息流最终需要同步，即需要一个核算系统来确认同步过程准确无误

#### 点券系统

- 资金流和信息流是一致的

```mermaid
sequenceDiagram
  业务系统 ->> 支付网关: 发起交易订单:用户A用10元向用户B购买一支笔并生成支付订单
  支付网关 ->> 支付网关: 处理支付订单
  支付网关 ->> 财务系统: 用户A扣10元
  支付网关 ->> 财务系统: 用户B加10元
  查询系统 ->> 财务系统: 查询余额
  用户 ->> 查询系统: 查询余额
```

#### 支付系统

![20221225154731](/assets/20221225154731.webp)

异步系统对接时的架构设计原则：将同步系统的一次调用拆分成三个步骤：异步调用、轮询和对账

- 支付网关还需要实现路由能力，将内部资产和外部资产两种操作，分发给不同的资产处理组件
- 金融网关：会对接多家第三方支付公司或者银行，这样可以根据三方支付公司可用情况、费率等进行只能路由
- 外部资产管理系统需要对接第三方支付公司来完成银行卡转账业务
- 信息流是通过记账方式来保存的，需要财务系统来进行交易数据保存
- 如果轮询失败，需要在晚上与第三方支付公司进行对账，由核算系统来完成

#### 第三方支付系统

不能管理实际资金，因此都是信息流的处理系统

- 流量支持：月底的大量交易或者是电商大促的大量交易，都需要一些高并发处理手段来撑住这些流程
- 备付金资金池：将属于用户的钱都放在一个大的池子里。池子里的钱不分你我，将资金池看作一个整体来操作的，如果在不同银行准备资金池，不仅能实现跨行转账实时到账，同时也能省下跨行交易费用，有了支付牌照之后，第三方公司才可以建立用户的备付金资金池
- 清结算能力：处理的是多家银行之间的跨行转账，清算中心把自己当作一个外人，对资金池之间的转账交易进行清结算工作

![20221225155547](/assets/20221225155547.webp)

