# 视频技术

![2023312145123](/assets/2023312145123.webp)

## 视频基础

### 色彩格式

- GRAY 色彩空间：使用8位数据的来表示颜色

![GRAY](/assets/2022111194755.webp)

- YUV 色彩空间：Y 表示视频的灰阶值、UV 表示色彩度

![YUV图像示例](/assets/2022111195043.webp)

![yuv420格式表示宽度为 6、高度为 4的图像](/assets/2022111195138.webp)

- RGB 色彩空间：使用三个 8 位无符号整数（0 到 255）表示红色、绿色和蓝色的强度

![2022111195211](/assets/2022111195211.webp)

- HSL 和 HSV 色彩空间
  - HSL，就是色相（Hue）、饱和度（ Saturation）、亮度（ Lightness）
  - HSV 是色相（Hue）、饱和度（ Saturation）和明度（Value）

色相（H）是色彩的基本属性，就是颜色名称，如红色、黄色等；饱和度（S）是指色彩的纯度，越高色彩越纯，低则逐渐变灰，取 0～100% 的数值；明度（V）和亮度（L），同样取 0～100% 的数值

![2022111195421](/assets/2022111195421.webp)

### 色彩空间

> 也叫色域，指某种表色模式用所能表达的颜色构成的范围区域

### 帧率

> 一秒钟刷新的视频图像帧数

### 码率

> 指视频在单位时间内的数据量的大小，一般是 1 秒钟内的数据量，其单位一般是 Kb/s 或者 Mb/s

### 分辨率

> 分辨率通常由宽、高与像素点占用的位数组成，计算方式为图像的宽乘以高

### Stride

指的是图像存储时内存中每行像素所占用的空间，为了能够快速读取一行像素，我们一般会对内存中的图像实现内存对齐，比如 16 字节对齐

![2023312145940](/assets/2023312145940.webp)

如果读取时没有跳过这些填充的区域，那么渲染出来的图像就完全错了，产生花屏

### 缩放算法

目前绝大多数图像的缩放还是通过插值算法：都是使用周围已有的像素值通过一定的加权运算得到“插值像素值”

![2023312152254](/assets/2023312152254.webp)

插值算法：

- 最近邻插值：将目标图像中的目标像素位置，映射到原图像的映射位置；找到原图像中映射位置周围的 4 个像素；取离映射位置最近的像素点的像素值作为目标像素
  - 得到的放大图像大概率会出现块状效应，而缩小图像容易出现锯齿

- 双线性插值：先通过两次线性插值得到两个中间值，然后再通过对这两个中间值进行一次插值得到最终的结果
  - 取待插值像素周围的 4 个像素，将这 4 个像素值插值得到中间像素 m 和 n 的像素值，再对这m n插值，得到最终的像素值

![2023312152848](/assets/2023312152848.webp)

- 双三次插值：通过 BiCubic 基函数计算得到待插值像素周围 16 个像素的权重，然后将 16 个像素加权平均就可以得到最终的待插值像素

## 视频编码

### 原理

视频由一帧帧图象个构成，而对于每一帧图像，又是划分成一个个块来进行编码

图像一般都是有数据冗余：

- 空间冗余：相邻的块很多时候都有比较明显的相似性
- 时间冗余：两帧图像的变化是比较小的
- 视觉冗余：人眼对图像中的高频信息不敏感
- 信息熵冗余：即文件压缩

帧内预测：在当前编码图像内部已经编码完成的块中找到与将要编码的块相邻的块，再用编码块减去每一个预测块得到一个个残差块。最后，我们取这些算法得到的残差块中像素的绝对值加起来最小的块为预测块

帧间预测：

分离图像块的高频和低频信息：DCT变换

去除掉大部分高频信息：量化

### 编解码器

编码标准|块大小和划份方式|帧内编码|帧间编码|变换|熵编码|滤波和后处理
-|-|-|-|-|-|-
H264|最大16x16，可划分成8X16、16X8、8X8、4X8、8X4、4X4|8个方向模式+planar+DC模式|中值MVP|DCT 4X4/8X8|CAVLC、CABAC|去块滤波
H265|最大支持64x64,四叉树划分|33个方向模式+planar+DC模式|Merget模式，AMVP模式|DCT 4X4/8X8/16X16/32X32，DST 4X4|CABAC|去块滤波，SAO滤波
AV1|最大支持128x128,四叉树划分|56个方向模式+3个平滑模式+递归Filterlntra模式+色度CFL模式+调色板模式+帧内块拷贝模式|OBMC+扭曲运动补偿+高级复合预测+复合帧内预测|4x4-64x64正方形+1:2/2:1+1:4/4:1矩形DCT/ADST/flipADST/IDTX|多符号算术编码|去块滤波，CDEF，LR滤波，Frame超分，Film Grain

H264 和 H265 是需要专利费的，而 VP8 和 VP9 完全免费

在软件编码下的情况下，相同码率下，AV1 清晰度稍好于 H265，而 H264 最差，但是编码耗时则相反，AV1 最高，H265 次之，H264 速度最快

### h264

如果范围内帧大部分都是相同的，那刷新第一帧图像后，从第二帧开始，我们只要刷新正中心字母区域的内容即可。这个叫局部更新

![2022111202335](/assets/2022111202335.webp)

- I 帧作为关键帧，仅由帧内预测的宏块组成
- P 帧代表预测帧，通过使用已经编码的帧进行运动估计
- B 帧则可以参考自己前后出现的帧

H264 编码标准中规定，IDR 帧之后的帧不能再参考 IDR 帧之前的帧

压缩后的视频码率也就变得比常规图像更高一些，这个码率的波动通常时高时低，具有可变性，我们一般称之为可变码率（VBR）

#### 封装

容器格式：在容器格式的内部会同时存储音频、视频的数据

- 交错存储：对顺序读取比较友好
- 分区存储：这种对磁盘、网络流不友好，因为需要不断跳跃读取数据

#### GOP

GOP（图像组）：从一个 IDR 帧开始到下一个 IDR 帧的前一帧为止，这个间隔叫做关键帧间隔

![20230315205104](/assets/20230315205104.webp)

GOP 太大，也会导致 IDR 帧距离太大，点播场景时进行视频的 seek 操作就会不方便

#### Slice

为了并行编码设计的，可以将一帧图像划分成几个 Slice，Slice 之间相互独立，就可以多线程并行对多个 Slice 进行编码

#### 码流结构

Annexb格式：

使用起始码来表示一个编码数据的开始，一种是 4 字节的“00 00 00 01”，一种是 3 字节的“00 00 01”，为了避免编码的数据中有跟起始码一样，需要做一下替换

- “00 00 00”修改为“00 00 03 00”
- “00 00 01”修改为“00 00 03 01”
- “00 00 02”修改为“00 00 03 02”
- “00 00 03”修改为“00 00 03 03”

![20230315205950](/assets/20230315205950.webp)

MP4 格式没有起始码，而是在图像编码数据的开始使用了 4 个字节作为长度标识

![20230315210250](/assets/20230315210250.webp)

帧在码流中实际上是以 Slice 的形式呈现的，H264 的码流主要是由 SPS、PPS、I Slice、P Slice和B Slice 组成的

为了区分这几种数据，使用一个名为NALU的结构来封装数据

![20230315210752](/assets/20230315210752.webp)
