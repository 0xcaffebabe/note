{"name":"ElasticSearch","id":"ä¸­é—´ä»¶-æ•°æ®åº“-ElasticSearch","content":"# ElasticSearch\n\n## ä¸€ã€ElasticSearch çš„è®¾è®¡ç›®æ ‡ä¸å“²å­¦\n\n### 1.1 æ ¸å¿ƒé—®é¢˜å®šä¹‰ï¼ˆç¬¬ä¸€æ€§åŸç†ï¼‰\n\nElasticSearch è§£å†³çš„ä¸æ˜¯â€œå­˜æ•°æ®â€ï¼Œè€Œæ˜¯ï¼š\n\n> **å¦‚ä½•åœ¨æµ·é‡æ•°æ®ä¸Šï¼Œä½å»¶è¿Ÿåœ°å®Œæˆæ¨¡ç³Šæœç´¢ã€ç›¸å…³åº¦è®¡ç®—ä¸èšåˆåˆ†æï¼Œå¹¶ä¸”å¯ä»¥æ¨ªå‘æ‰©å±•ã€‚**\n\nç”±æ­¤å†³å®šäº† ES çš„ä¸€åˆ‡è®¾è®¡å–èˆã€‚\n\n### 1.2 ä¸‰ä¸ªåŸºæœ¬å‡è®¾\n\n1. **æœç´¢æ¯”äº‹åŠ¡æ›´é‡è¦**ï¼ˆSearch > Transactionï¼‰\n2. **è¯»å¤šå†™å°‘ï¼Œå…è®¸è¿‘å®æ—¶**ï¼ˆNRT è€Œéå¼ºä¸€è‡´ï¼‰\n3. **æ•°æ®è§„æ¨¡ä¸€å®šä¼šè¶…è¿‡å•æœºæé™**ï¼ˆå¿…é¡»åˆ†å¸ƒå¼ï¼‰\n\nè¿™äº›å‡è®¾ç›´æ¥å¦å®šäº†ä¼ ç»Ÿ OLTP æ•°æ®åº“çš„è®¾è®¡è·¯å¾„ã€‚\n\n---\n\n## äºŒã€ES çš„å››å¤§ç¬¬ä¸€æ€§æ¨¡å‹ï¼ˆä¸–ç•Œè§‚å±‚ï¼‰\n\n### 2.1 å­˜å‚¨æ¨¡å‹ï¼šä¸å¯å˜æ®µï¼ˆImmutable Segmentï¼‰\n\n* æ•°æ®ä¸€æ—¦å†™å…¥ Segmentï¼Œä¸å†ä¿®æ”¹\n* æ›´æ–° / åˆ é™¤ = æ ‡è®° + æ–°å†™å…¥\n* é€šè¿‡ Merge è§£å†³ç©ºé—´ä¸æ€§èƒ½é—®é¢˜\n\n**æœ¬è´¨åŠ¨æœº**ï¼š\n\n* é¿å…éšæœºå†™\n* æœ€å¤§åŒ–é¡ºåº IO\n* æå‡æŸ¥è¯¢å¹¶å‘ä¸ç¼“å­˜å‘½ä¸­ç‡\n\n> **ä¸å¯å˜æ€§æ˜¯ ES é«˜å¹¶å‘æœç´¢çš„æ ¹åŸºã€‚**\n\n---\n\n### 2.2 è®¡ç®—æ¨¡å‹ï¼šShard çº§å¹¶è¡Œè®¡ç®—\n\n* ä¸€ä¸ª Shard = ä¸€ä¸ª Lucene Index\n* æŸ¥è¯¢åœ¨æ‰€æœ‰ Shard ä¸Šå¹¶è¡Œæ‰§è¡Œ\n* ç»“æœåœ¨åè°ƒèŠ‚ç‚¹åš Reduce\n\n**æ¨è®º**ï¼š\n\n* Shard æ˜¯æ€§èƒ½ä¸æ‰©å±•çš„æœ€å°å•å…ƒ\n* è¿‡å¤š / è¿‡å°‘åˆ†ç‰‡éƒ½ä¼šå¯¼è‡´ç³»ç»Ÿé€€åŒ–\n\n---\n\n### 2.3 ä¸€è‡´æ€§æ¨¡å‹ï¼šä¸»åˆ†ç‰‡ + æœ€ç»ˆä¸€è‡´\n\n* å†™å…¥åªå‘ç”Ÿåœ¨ Primary Shard\n* Replica å¼‚æ­¥å¤åˆ¶\n* é€šè¿‡ seq_no + primary_term å®ç°ä¹è§‚é”\n\n**æœ¬è´¨å–èˆ**ï¼š\n\n> ç”¨ä¸€è‡´æ€§æ¢å¯ç”¨æ€§ä¸æ€§èƒ½ï¼ˆCAP ä¸­åå‘ APï¼‰ã€‚\n\n---\n\n### 2.4 æ‰©å±•æ€§æ¨¡å‹ï¼šæ°´å¹³æ‰©å±•ä¼˜å…ˆ\n\n* ä¸æ”¯æŒè‡ªåŠ¨æ‹†åˆ†å•ä¸ª Shard\n* æ‰©å±•é  Shard åœ¨èŠ‚ç‚¹é—´é‡æ–°åˆ†å¸ƒ\n\n**ç»“è®º**ï¼š\n\n> åˆ†ç‰‡æ•°æ˜¯ä¸€æ¬¡æ€§æ¶æ„å†³ç­–ï¼Œä¸æ˜¯è¿è¡ŒæœŸå‚æ•°ã€‚\n\n---\n\n## ä¸‰ã€æ ¸å¿ƒæŠ½è±¡æ¨¡å‹ï¼ˆæ¦‚å¿µè¾¹ç•Œæ¾„æ¸…ï¼‰\n\n### 3.1 æ¦‚å¿µå±‚çº§æ˜ å°„\n\n| æŠ½è±¡å±‚ | ES æ¦‚å¿µ    | æœ¬è´¨å«ä¹‰       |\n| --- | -------- | ---------- |\n| é›†ç¾¤  | Cluster  | èµ„æºä¸çŠ¶æ€ä¸€è‡´æ€§è¾¹ç•Œ |\n| èŠ‚ç‚¹  | Node     | è®¡ç®—ä¸å­˜å‚¨æ‰§è¡Œå•å…ƒ  |\n| ç´¢å¼•  | Index    | é€»è¾‘æ•°æ®é›†åˆ     |\n| åˆ†ç‰‡  | Shard    | å¹¶è¡Œä¸æ‰©å±•å•ä½    |\n| æ®µ   | Segment  | ä¸å¯å˜å€’æ’ç´¢å¼•æ–‡ä»¶  |\n| æ–‡æ¡£  | Document | æœ€å°æ£€ç´¢å¯¹è±¡     |\n\n> **Index â‰  Databaseï¼ŒShard â‰  Table Partitionã€‚**\n\n---\n\n## å››ã€æ•°æ®ç”Ÿå‘½å‘¨æœŸï¼ˆä»å†™å…¥åˆ°æ¶ˆäº¡ï¼‰\n\n### 4.1 å†™å…¥è·¯å¾„ï¼ˆè¿‘å®æ—¶æœ¬è´¨ï¼‰\n\n1. å†™å…¥ Memory Buffer + Translog\n2. Refreshï¼šç”Ÿæˆå¯æœç´¢ Segmentï¼ˆ1sï¼‰\n3. Flushï¼šSegment æŒä¹…åŒ– + Commit Point\n4. Mergeï¼šåå°åˆå¹¶æ®µæ–‡ä»¶\n\n**å…³é”®è®¤çŸ¥**ï¼š\n\n* å¯æœç´¢ â‰  å·²è½ç›˜\n* Refresh æ˜¯æœç´¢è¯­ä¹‰ï¼ŒFlush æ˜¯æŒä¹…åŒ–è¯­ä¹‰\n\n---\n\n### 4.2 è¯»å–ä¸æœç´¢è·¯å¾„\n\n* Shard æœ¬åœ°æ‰§è¡Œ Query\n* åˆ©ç”¨ Filesystem Cache\n* åè°ƒèŠ‚ç‚¹å®Œæˆæ’åº / åˆ†é¡µ / èšåˆ\n\n> æœç´¢æ€§èƒ½ â‰ˆ Cache å‘½ä¸­ç‡ Ã— å¹¶è¡Œåº¦\n\n---\n\n## äº”ã€åˆ†å¸ƒå¼æŸ¥è¯¢ä¸ç®—åˆ†æ¨¡å‹\n\n### 5.1 ä¸¤é˜¶æ®µæœç´¢æ¨¡å‹\n\n1. Query Phaseï¼šæ¯ä¸ª Shard æœ¬åœ°ç®—åˆ†\n2. Fetch Phaseï¼šåè°ƒèŠ‚ç‚¹æ‹‰å–æ–‡æ¡£\n\n### 5.2 ç®—åˆ†ä¸å‡†çš„æ ¹å› \n\n* Shard ä¹‹é—´ç»Ÿè®¡ä¿¡æ¯éš”ç¦»\n* IDF åŸºäºå±€éƒ¨æ•°æ®\n\n**è§£å†³æ–¹æ¡ˆ**ï¼š\n\n* å•ä¸»åˆ†ç‰‡\n* dfs_query_then_fetch\n\n---\n\n## å…­ã€æ•°æ®å»ºæ¨¡çš„å·¥ç¨‹å“²å­¦\n\n### 6.1 å»ºæ¨¡ç¬¬ä¸€åŸåˆ™\n\n1. **ä¸ºæŸ¥è¯¢å»ºæ¨¡ï¼Œè€Œéä¸ºå­˜å‚¨å»ºæ¨¡**\n2. **åèŒƒå¼ä¼˜äºèŒƒå¼**\n3. **å†™å…¥æˆæœ¬ < æŸ¥è¯¢å¤æ‚åº¦**\n\n### 6.2 ä¸‰ç§ç»“æ„çš„å–èˆ\n\n| æ¨¡å‹           | ä½¿ç”¨åœºæ™¯  | ä»£ä»·       |\n| ------------ | ----- | -------- |\n| æ‰å¹³æ–‡æ¡£         | é»˜è®¤é€‰æ‹©  | å†™å…¥å†—ä½™     |\n| Nested       | å±€éƒ¨å¼ºå…³è” | æŸ¥è¯¢æ…¢      |\n| Parent-Child | é«˜é¢‘æ›´æ–°  | å†…å­˜ä¸ç®—åˆ†æˆæœ¬é«˜ |\n\n---\n\n## ä¸ƒã€èµ„æºä¸æ€§èƒ½æ¨¡å‹\n\n### 7.1 ä¸‰å¤§ç“¶é¢ˆ\n\n* CPUï¼šæŸ¥è¯¢ã€èšåˆã€è„šæœ¬\n* å†…å­˜ï¼šSegment Metadata / Fielddata\n* IOï¼šMerge / å†·æ•°æ®è®¿é—®\n\n### 7.2 ç¼“å­˜å“²å­¦\n\n* Filesystem Cache æ˜¯ç‹è€…\n* ES å†…éƒ¨ç¼“å­˜æ˜¯è¾…åŠ©\n\n> **ä¸ç»™ OS å†…å­˜ï¼Œå°±æ˜¯ä¸»åŠ¨æ”¾å¼ƒæ€§èƒ½ã€‚**\n\n---\n\n## å…«ã€å®¹é‡è§„åˆ’ä¸æ¼”è¿›ç­–ç•¥\n\n### 8.1 å®¹é‡è§„åˆ’ä¸æ˜¯ç®—å…¬å¼\n\nè€Œæ˜¯å›ç­”ï¼š\n\n* æ•°æ®å¢é•¿æ›²çº¿\n* æŸ¥è¯¢æ¨¡å‹ç¨³å®šæ€§\n* æ•…éšœæ—¶æ˜¯å¦å¯é™çº§\n\n### 8.2 ç´¢å¼•æ¼”è¿›ç­–ç•¥\n\n* æ—¶é—´åˆ†åŒºï¼ˆæ—¥å¿—ï¼‰\n* ä¸šåŠ¡åˆ†åŒºï¼ˆå®ä½“æ•°æ®ï¼‰\n* ILMï¼šHot â†’ Warm â†’ Cold â†’ Delete\n\n---\n\n## ä¹ã€æ²»ç†ã€ç›‘æ§ä¸ç³»ç»Ÿç¨³å®šæ€§\n\n### 9.1 Cluster State æ˜¯æ ¸å¿ƒå…±äº«èµ„æº\n\n* Mapping\n* Shard å…ƒæ•°æ®\n* Index é…ç½®\n\n**åŸåˆ™**ï¼š\n\n> å‡å°‘å˜æ›´é¢‘ç‡ï¼Œæ§åˆ¶è§„æ¨¡ã€‚\n\n### 9.2 å¥åº·åº¦è®¤çŸ¥\n\n* Greenï¼šç†æƒ³æ€\n* Yellowï¼šå¯è¿è¡Œä½†æœ‰é£é™©\n* Redï¼šæœåŠ¡ä¸å®Œæ•´\n\n---\n\n## åã€åæ¨¡å¼ï¼ˆAnti-Patternsï¼‰\n\n* æŠŠ ES å½“æ•°æ®åº“ç”¨\n* å¤§é‡ Join / Nested æŸ¥è¯¢\n* æ— é™åˆ¶æ·±åº¦åˆ†é¡µ\n* åŠ¨æ€å­—æ®µå¤±æ§\n* åˆ†ç‰‡æ•°æ‹è„‘è¢‹\n\n---\n\n## åä¸€ã€ES çš„èƒ½åŠ›è¾¹ç•Œ\n\n### ES é€‚åˆ\n\n* æœç´¢\n* å®æ—¶åˆ†æ\n* æ—¥å¿—ä¸è¡Œä¸ºæ•°æ®\n\n### ES ä¸é€‚åˆ\n\n* å¼ºäº‹åŠ¡\n* è´¦åŠ¡ç³»ç»Ÿ\n* å¤æ‚å…³ç³»å‹æŸ¥è¯¢\n\n## å…³è”å†…å®¹ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰\n\n- [/æ•°æ®æŠ€æœ¯/æ£€ç´¢æŠ€æœ¯.md](/æ•°æ®æŠ€æœ¯/æ£€ç´¢æŠ€æœ¯.md) æ£€ç´¢æŠ€æœ¯æ¶µç›–äº†å€’æ’ç´¢å¼•ã€æœç´¢ç©ºé—´è£å‰ªã€å€™é€‰ç”Ÿæˆç­‰æ ¸å¿ƒæŠ€æœ¯ï¼Œä¸ElasticSearchçš„æœç´¢åŸç†å’Œå®ç°æœºåˆ¶å¯†åˆ‡ç›¸å…³\n- [/ä¸­é—´ä»¶/æ•°æ®åº“/ç´¢å¼•.md](/ä¸­é—´ä»¶/æ•°æ®åº“/ç´¢å¼•.md) ç´¢å¼•æŠ€æœ¯è¯¦ç»†ä»‹ç»äº†B+æ ‘ã€å“ˆå¸Œç´¢å¼•ã€ä½å›¾ç´¢å¼•ç­‰æ•°æ®ç»“æ„ï¼Œè¿™äº›æ˜¯ElasticSearchä¸­æ®µï¼ˆSegmentï¼‰å’Œå€’æ’ç´¢å¼•çš„åº•å±‚å®ç°åŸºç¡€\n- [/è½¯ä»¶å·¥ç¨‹/æ¶æ„/ç³»ç»Ÿè®¾è®¡/åˆ†å¸ƒå¼/åˆ†å¸ƒå¼ç³»ç»Ÿ.md](/è½¯ä»¶å·¥ç¨‹/æ¶æ„/ç³»ç»Ÿè®¾è®¡/åˆ†å¸ƒå¼/åˆ†å¸ƒå¼ç³»ç»Ÿ.md) åˆ†å¸ƒå¼ç³»ç»Ÿç†è®ºæ¶µç›–äº†CAPå®šç†ã€ä¸€è‡´æ€§æ¨¡å‹ã€åˆ†ç‰‡ç­–ç•¥ç­‰æ¦‚å¿µï¼Œè¿™äº›éƒ½æ˜¯ElasticSearchåˆ†å¸ƒå¼æ¶æ„è®¾è®¡çš„æ ¸å¿ƒåŸç†\n- [/ä¸­é—´ä»¶/æ•°æ®åº“/åˆ†å¸ƒå¼æ•°æ®åº“.md](/ä¸­é—´ä»¶/æ•°æ®åº“/åˆ†å¸ƒå¼æ•°æ®åº“.md) åˆ†å¸ƒå¼æ•°æ®åº“çš„åˆ†ç‰‡ï¼ˆShardingï¼‰ã€å‰¯æœ¬å¤åˆ¶ã€ä¸€è‡´æ€§æ¨¡å‹ç­‰å†…å®¹ä¸ElasticSearchçš„åˆ†å¸ƒå¼æ¶æ„å’Œæ•°æ®ç®¡ç†æ–¹å¼æœ‰è¯¸å¤šç›¸ä¼¼ä¹‹å¤„ï¼Œå¯ä½œå¯¹æ¯”å‚è€ƒ\n","metadata":"tags: ['ä¸­é—´ä»¶', 'åˆ†å¸ƒå¼ç³»ç»Ÿ', 'æ•°æ®åº“']","hasMoreCommit":true,"totalCommits":26,"commitList":[{"date":"2026-02-12T14:07:03+08:00","author":"MY","message":"doc: æ•´ç†æ ‡ç­¾","hash":"290b3e8ad18f48832ac282290238d020fc030a88"},{"date":"2026-01-12T19:35:20+08:00","author":"MY","message":"doc(elasticsearch): é‡æ„æ–‡æ¡£","hash":"355474c70caf0df19eec17610dba76906c6ef7b1"},{"date":"2024-12-12T15:26:38+08:00","author":"MY","message":"ğŸ“¦ES","hash":"28b974130d8b4a8ae778d39e061492a9ceeaf871"},{"date":"2024-11-20T19:43:10+08:00","author":"MY","message":"âœES","hash":"270b0046fd04c188311d1ec73be1cd3b76a9c403"},{"date":"2024-07-17T15:54:07+08:00","author":"MY","message":"âœES","hash":"06cfd00bffe6d7d4c91c3aad727c982645d3aeea"},{"date":"2024-07-10T20:07:07+08:00","author":"MY","message":"âœES","hash":"530693ddb6a170ef95e83e016a78b99c6a3c2afb"},{"date":"2024-07-09T20:10:40+08:00","author":"MY","message":"âœES","hash":"5ca1fa41444725bf69b3a526fb578f57a2110978"},{"date":"2024-07-08T20:12:06+08:00","author":"MY","message":"âœES","hash":"1d37eaff55d1d757c29cddf43495f567cfeaa82e"},{"date":"2024-07-08T17:04:51+08:00","author":"MY","message":"âœES","hash":"073af9b7436f29f48782ac072e87c0cd99887823"},{"date":"2024-07-04T16:10:57+08:00","author":"MY","message":"âœES","hash":"e954c3ec638854e03ec500320021f9e573e998eb"}],"createTime":"2019-09-03T22:29:51+08:00"}