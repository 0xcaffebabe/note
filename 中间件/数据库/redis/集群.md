---
tags: ['数据库', '分布式系统', '架构设计', '可扩展性']
---

# Redis Cluster

## 一、问题定义层（Why）——Redis Cluster 试图解决什么？

### 1. Redis 单机模型的物理极限

Redis 本质是：

> **单进程、内存型、事件驱动的 Key-Value 引擎**

这一模型带来极高性能的同时，也内生了不可突破的上限：

* **内存上限**：单机内存容量有限
* **CPU 上限**：单线程模型难以纵向扩展
* **IO 上限**：网络与事件循环竞争

当数据规模与并发持续增长时，单机 + 主从复制只能解决**可用性**，而无法解决**容量与吞吐扩展**。

### 2. Redis Cluster 的核心目标

Redis Cluster 的目标可以高度抽象为一句话：

> **在保持 Redis 简单模型的前提下，实现容量与吞吐的水平扩展（Scale Out）**

因此，它的设计优先级是：

1. 可线性扩展
2. 去中心化
3. 自动化故障恢复

而不是：

* 跨节点强一致事务
* 复杂查询
* 完整数据库语义

> **这是一个“缓存系统”的架构选择，而不是“数据库”的选择。**

---

## 二、核心架构思想（What）——Redis Cluster 的三大不变原则

### 原则一：数据必须分片（Sharding is Mandatory）

要突破单机极限，唯一出路是：

> **将 Key 空间切分，分布到多个节点上**

这意味着：

* 一个 Key 只能归属于一个节点
* 多 Key 操作天然会跨节点

从这一刻起，**分布式事务被放弃是必然结果，而非实现缺陷**。

---

### 原则二：拓扑变化必须对客户端最小侵入

集群意味着：

* 节点会增加
* 节点会下线
* 主从会切换

如果客户端需要理解全部拓扑变化，系统将极度复杂。

因此 Redis Cluster 引入了一个**稳定的中间抽象层**：

> **Hash Slot（虚拟槽）**

---

### 原则三：系统必须去中心化

Redis Cluster 明确拒绝：

* 中心元数据节点
* 强一致协调服务

选择的是：

> **所有节点平权 + 最终一致的集群视图**

这是一个典型的分布式系统工程取舍。

---

## 三、机制层（How）——关键设计如何落地

## 3.1 Slot：稳定抽象边界（Stable Abstraction Boundary）

### Slot 的本质

Redis Cluster 固定定义：

* **16384 个 Hash Slot**
* Key → CRC16(key) % 16384 → Slot

Slot 的设计目标不是均匀，而是：

> **稳定**

Slot 作为中间层，完成了三重解耦：

```
Key  ──▶ Slot ──▶ Node ──▶ Memory
```

* 解耦 Key 与 Node
* 解耦客户端与节点变化
* 解耦扩缩容与数据语义

> **Slot 是人为引入的“稳定边界”，不是数学最优解。**

---

## 3.2 路由模型：客户端参与的去中心化路由

### MOVED：稳定态路由

当客户端访问错误节点时：

* 节点返回 `MOVED slot ip:port`
* 客户端更新本地 slot → node 缓存

这是一种：

> **将路由状态下推给客户端的设计**

优点：

* 节点无路由压力
* 集群无中心瓶颈

代价：

* 客户端必须具备集群感知能力

---

### ASK：过渡态路由

ASK 出现于：

> **Slot 正在迁移过程中**

它的语义是：

* 这是一次“临时指路”
* 客户端**不应更新**本地路由表

这体现了 Redis Cluster 的一个重要哲学：

> **承认系统处于不稳定中间态，而不是强行隐藏它**

---

## 3.3 成员管理：Gossip 作为控制平面

### 去中心化控制平面

Redis Cluster 没有：

* Master Controller
* Meta Server

而是通过 Gossip 协议：

* 每个节点维护一份集群视图
* 通过 Ping/Pong 不断交换状态

这意味着：

* 集群视图是**最终一致**的
* 状态传播存在延迟

> **这是用确定性换取可扩展性的经典模式**

---

## 四、高可用模型（Failover）——可用性优先的选择

### 4.1 故障判定

* 主观下线：单节点判断
* 客观下线：多数节点确认

这是一个：

> **弱共识 + 多数派确认** 的模型

---

### 4.2 主节点替换

当持有 Slot 的主节点失败：

* 其从节点参与竞选
* 获胜者接管 Slot

注意：

> **Failover 的对象是 Slot，而不是节点本身**

---

## 五、伸缩机制（Scaling）——在线系统的代价

### 5.1 扩容的本质

扩容不是“加机器”，而是：

> **重新分配 Slot 责任**

过程包括：

1. 标记迁移状态
2. 同步迁移 Key
3. 更新 Slot 映射

迁移是：

* 同步读写
* 会阻塞源节点

这是在线系统为一致性付出的现实代价。

---

## 六、代价层（Trade-off）——必须接受的限制

这些限制不是"缺陷"，而是设计结果。

| 限制          | 架构根因   |
| ----------- | ------ |
| 多 Key 操作受限  | 数据分片   |
| 单 DB        | 简化元数据  |
| Pub/Sub 成本高 | 全节点广播  |
| 热点 Key      | 分片粒度固定 |

---

## 七、运维视角：从现象到模式

### 模式一：去中心化的通信放大

* Gossip 带来 O(N²) 消息趋势
* 节点越多，控制流量越大

### 模式二：稳定抽象的迁移成本

* Slot 稳定
* 数据迁移昂贵

### 模式三：逻辑均匀 ≠ 物理均匀

* Slot 均匀
* Key 热度不均

---

## 八、架构定位总结

Redis Cluster 是：

* 一个 **去中心化的分布式缓存系统**
* 一个 **为扩展性牺牲强一致性的工程方案**

它非常适合：

* 大规模缓存
* 会话数据
* 高吞吐 KV 场景

但不适合：

* 强事务系统
* 复杂查询
* 数据库替代方案

## 关联内容（自动生成）

- [/中间件/数据库/redis/Redis.md](/中间件/数据库/redis/Redis.md) Redis的核心概念、数据结构和基本操作，与集群架构形成基础与扩展的关系
- [/中间件/数据库/redis/复制.md](/中间件/数据库/redis/复制.md) Redis复制机制是集群实现高可用的基础，了解复制原理有助于理解集群的主从切换机制
- [/中间件/数据库/redis/哨兵.md](/中间件/数据库/redis/哨兵.md) Redis Sentinel提供了高可用性解决方案，与Redis Cluster在故障转移机制上有不同的设计理念
- [/中间件/数据库/redis/数据结构.md](/中间件/数据库/redis/数据结构.md) Redis的数据结构是集群节点存储的基础，理解数据结构有助于优化集群的数据分布
- [/中间件/数据库/redis/持久化.md](/中间件/数据库/redis/持久化.md) Redis持久化机制在集群环境中同样重要，关系到数据的安全性和恢复能力
- [/软件工程/架构/系统设计/分布式/分布式系统.md](/软件工程/架构/系统设计/分布式/分布式系统.md) 分布式系统的基本概念和原理，为理解Redis Cluster的设计思想提供理论基础
- [/软件工程/架构/系统设计/分布式/分布式理论.md](/软件工程/架构/系统设计/分布式/分布式理论.md) 分布式理论（如CAP定理、一致性模型）是理解Redis Cluster架构权衡的关键
- [/软件工程/架构/系统设计/缓存.md](/软件工程/架构/系统设计/缓存.md) 缓存系统的设计原则和模式，Redis Cluster作为分布式缓存系统的应用场景和设计考量
- [/软件工程/架构/系统设计/可用性.md](/软件工程/架构/系统设计/可用性.md) 系统可用性的设计原则，Redis Cluster的故障检测和恢复机制是实现高可用的重要手段
- [/软件工程/架构/系统设计/扩展性.md](/软件工程/架构/系统设计/扩展性.md) 系统扩展性的设计方法，Redis Cluster通过数据分片实现水平扩展的具体实践
- [/软件工程/架构/系统设计/分布式/分布式数据.md](/软件工程/架构/系统设计/分布式/分布式数据.md) 分布式环境下的数据管理策略，与Redis Cluster的数据分片和迁移机制密切相关
- [/中间件/数据库/分布式数据库.md](/中间件/数据库/分布式数据库.md) 分布式数据库的设计理念和技术，与Redis Cluster在数据分布和一致性方面形成对比
- [/软件工程/架构/系统设计/分布式/分布式一致性与协调机制.md](/软件工程/架构/系统设计/分布式/分布式一致性与协调机制.md) 分布式一致性协议和协调机制，Redis Cluster采用最终一致性模型的设计考量
- [/软件工程/架构/系统设计/架构设计.md](/软件工程/架构/系统设计/架构设计.md) 系统架构设计的原则和方法，Redis Cluster体现了去中心化、可扩展的架构思想
- [/算法与数据结构/散列表.md](/算法与数据结构/散列表.md) Redis内部使用散列表作为核心数据结构之一，理解散列表有助于理解Redis的数据存储机制
