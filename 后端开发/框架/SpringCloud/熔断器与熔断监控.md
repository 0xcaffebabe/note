# 熔断器

**级联故障**

![](http://favorites.ren/assets/images/2017/springcloud/hystrix-2.png)

## Hystrix

- 断路器机制
- Fallback
- 资源隔离

>熔断只是作用在服务调用这一端

### 添加熔断机制

- 开启配置

```properties
feign.hystrix.enabled=true
```

- 编写fallback

```java
@Component
public class HelloRemoteHystrix implements HelloRemote {
    @Override
    public String hello(String name) {
        return "sorry,service call failed";
    }
}
```

```java
    @RequestMapping("/user")
    @HystrixCommand(fallbackMethod = "userFall")
    public String user(){

        return restTemplate.getForObject("http://user-service/user",String.class);
    }

    public String userFall(){
        return "call failed";
    }
```

- 添加通用降级逻辑

```java
@DefaultProperties(defaultFallback = "userFall")
public class Controller {...}
```

- 超时时间

```java
@RequestMapping("/user")
    @HystrixCommand(commandProperties = {@HystrixProperty(name = "execution.isolation.thread.timeoutInMilliseconds",value = "5000")})
    public String user(){

        return restTemplate.getForObject("http://user-service/user",String.class);
    }
```

- 在远程调用接口上添加fallback

```java
@FeignClient(value = "producer",fallback = HelloRemoteHystrix.class)
public interface HelloRemote {

    @RequestMapping("/hello")
    String hello(@RequestParam String name);
}
```

这样一旦producer挂掉了，将会返回默认结果

# 熔断监控 Hystrix-dashboard

>通过Hystrix Dashboard我们可以在直观地看到各Hystrix Command的请求响应时间, 请求成功率等数据

## 单个应用的熔断监控

- 添加依赖

```xml
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-hystrix</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-hystrix-dashboard</artifactId>

        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>
```

- 打开自动配置

```java
@EnableCircuitBreaker
@EnableHystrixDashboard
```

- 如果发生404则添加如下配置

```java
@Bean
    public ServletRegistrationBean getServlet() {
        HystrixMetricsStreamServlet streamServlet = new HystrixMetricsStreamServlet();
        ServletRegistrationBean registrationBean = new ServletRegistrationBean(streamServlet);
        registrationBean.setLoadOnStartup(1);
        registrationBean.addUrlMappings("/hystrix.stream");
        registrationBean.setName("HystrixMetricsStreamServlet");
        return registrationBean;
    }
```

- 访问

>http://127.0.0.1:10000/hystrix/

## Turbine

- 添加依赖

```xml
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-hystrix</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-hystrix-dashboard</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-turbine</artifactId>
        </dependency>
```

- 配置

```properties
spring.application.name=hystrix-dashboard-turbine
server.port=11000
turbine.appConfig=node1,node2

turbine.aggregator.clusterConfig= default
turbine.clusterNameExpression= new String("default")

eureka.client.serviceUrl.defaultZone=http://localhost:8001/eureka/
```

```java
@EnableTurbine
@EnableHystrixDashboard
```

![批注 2019-07-24 155313](/assets/批注%202019-07-24%20155313.png)