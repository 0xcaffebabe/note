# 垃圾回收

> 一个跟踪过程，它传递性地跟踪指向当前使用的对象的所有指针，以便找到可以引用的所有对象，然后重新使用在此跟踪过程中未找到的任何堆内存。公共语言运行库垃圾回收器还压缩使用中的内存，以缩小堆所需要的工作空间

## JAVA对象生命周期

### 内存回收API

- Object的finalize方法，垃圾收集器在回收对象时调用，有且仅被调用一次
- System的gc方法。不靠谱

## JAVA对象引用

- 基于对象引用判定无用对象
- 对象引用链

### 强引用

- 如Object obj = new Object(); Object obj2 = obj;
- 强引用还存在，对象就不会被回收，哪怕发生OOM异常

### 软引用

- 有用但并非必需的对象
- 在系统将要发生内存溢出异常之前，会把这些对象列为可回收

### 弱引用

- 比软引用强度更弱些
- 只能生存到下一次垃圾收集发生之前

### 虚引用

- 为一个对象设置虚引用关联的唯一目的就是能在这个对象被收集器回收时收到一个系统通知，用于对象回收跟踪

### 总结

引用类型 | 强引用  | 软引用           | 弱引用           | 虚引用
---- | ---- | ------------- | ------------- | ----------------
类型   | 正常赋值 | SoftReference | WeakReference | PhantomReference
回收时间 | 不回收  | 内存紧张时回收       | GC就回收         | 随时可能被回收

## 垃圾回收算法

### 引用计数法

> 最早期的垃圾回收实现方法，通过对数据存储的物理空间附加多一个计数器空间，当有其他数据与其相关时则加一，反之相关解除时减一，定期检查各储存对象的计数器，为零的话则认为已经被抛弃而将其所占物理空间回收。是最简单的实现，但存在无法回收循环引用的存储对象的缺陷

### 标记清除法

> GC 标记-清除算法由标记阶段和清除阶段构成。在标记阶段会把所有的活动对象都做上标记，然后在清除阶段会把没有标记的对象，也就是非活动对象回收

### 标记压缩算法

> 其中标记阶段跟标记-清除算法中的标记阶段是一样的,而对于压缩阶段，它的工作就是移动所有的可达对象到堆内存的同一个区域中，使他们紧凑的排列在一起，从而将所有非可达对象释放出来的空闲内存都集中在一起，通过这样的方式来达到减少内存碎片的目的

### 复制清除算法

> 把内存分为两个空间一个是From空间，一个是To空间，对象一开始只在From空间分配，To空间是空闲的。GC时把存活的对象从From空间复制粘贴到To空间，之后把To空间变成新的From空间，原来的From空间变成To空间

- JVM年轻代所使用的的回收算法

### 分代收集

不同对象使用不同的回收算法

- 新生代
  - 主要存放短暂生命周期的对象
  - 新创建的对象都先放入新生代，大部分新建对象在第一次gc时被回收
- 老年代
  - 一个对象经过几次gc仍存活，则放入老年代
  - 这些对象可以活很长时间，或者伴随程序一生，需要常驻内存的，可以减少回收次数

# 垃圾收集器与内存分配

- 串行垃圾收集器

  - STW（stop the world）
  - JAVA WEB应用不会使用该种收集器

```
[120.792s][info   ][gc           ] GC(25) Pause Young (Allocation Failure) 10M->6M(15M) 0.936ms
[120.792s][info   ][gc,cpu       ] GC(25) User=0.00s Sys=0.00s Real=**0.00s**
```

- 并行垃圾收集器

```
[GC (Allocation Failure) [ParNew: 4928K->512K(4928K), 0.0024282 secs] 7129K->3525K(15872K), 0.0024673 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]
```

- CMS垃圾收集器

> CMS是老年代垃圾收集器，在收集过程中可以与用户线程并发操作。它可以与Serial收集器和Parallel New收集器搭配使用。CMS牺牲了系统的吞吐量来追求收集速度，适合追求垃圾收集速度的服务器上

![](https://upload-images.jianshu.io/upload_images/2184951-cd90513432053c9a.png?imageMogr2/auto-orient/strip|imageView2/2/w/1200/format/webp)

- G1垃圾收集器

  - 开启
  - 设置堆最大内存
  - 设置最长停顿时间

![](https://user-gold-cdn.xitu.io/2018/5/8/1633b807bfc36594?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

G1使用建议：

- 避免设置年轻代大小
- 暂停时间不要太苛刻

# 可视化GC日志分析工具

[gceasy](http://gceasy.io)
