
# 学习内容

- 字节码文件结构
- 字节码生成
- 字节码操作
- 字节码增强
- 字节码反编译与混淆


# JAVA开发流程

.java - .class - 运行

# class 文件

- JVM所执行的二进制文件，跨平台的基础
- 满足这种规范的class文件都会被JVM加载运行
- 可以由其他语言编译生成
- 不同版本的JDK生成的类文件略有不同

![批注 2019-12-20 144534](/assets/批注%202019-12-20%20144534.png)

## 构成

- 包括两种数据类型
  - 定长数据
  - 不定长数据

前4个字节为魔数，十六进制表示为0xCAFEBABE，标识该文件为class文件

第5、6字节表示次版本号

- 反编译

```shell
javap -v classname
```

### 常量池

- 字面量
- 符号引用

### 访问标志

常量池结束之后的两个字节，描述该Class是类还是接口，以及是否被public、abstract、final等修饰符修饰

### 类索引

- 类索引
- 父类索引
- 接口索引

### 字段表

- 用于描述类和接口中声明的变量
- 第一部分为两个字节，描述字段个数；第二部分是每个字段的详细信息fields_info。

### 方法表

同字段表

### 附加属性

- 该项存放了在该文件中类或接口所定义属性的基本信息

## 字节码指令

[oracle 官方 pdf](https://docs.oracle.com/javase/specs/jvms/se13/jvms13.pdf)

### 内存结构

![](http://blog.cheyo.net/static/file/jvm_memory.png)

### 分类

- 加载和存储指令
  -  用于将数据在栈帧中的局部变量表和操作数栈之间来回传输
- 运算指令
- 类型转换指令
- 对象/数组创建与访问指令
- 操作数栈管理指令
- 控制转移指令
- 方法调用和返回指令
- 异常处理指令
- 同步控制指令

### 组成

- 操作码
- 操作数
- JVM指令集基于栈

### ASM

>ASM是一个通用的Java字节码操作和分析框架

- Core API
  - 不需要读取类的整个结构，使用流式的方法来处理字节码文件
  - 编程难度较大
- Tree API
  - 消耗内存多，但是编程比较简单
  - 通过各种Node类来映射字节码的各个区域

#### 字节码增强

- java agent
  - premain：支持在main函数之前，对类的字节码进行修改/替换
  - agentmain：支持在程序运行过程中，对字节码进行替换

#### 字节码混淆

- 使反编译的代码可读性变差
- ProGuard

## i++与++i

## String拼接与StringBuilder

- String的拼接操作在字节码层面是被编译成StringBuilder进行append
    - 如果在循环中使用+操作，则会创建许多StringBuilder对象

# 代码优化

- 使用局部变量
- 减少重复计算
- 懒加载
- 异常对性能不利
- 避免创建导入不使用的对象和类
- 反射对性能不利
- 连接池和线程池有利于提高性能
- 容器初始化指定长度
- 不同的数据结构在不同操作下的性能表现不同
- 使用键值对遍历Map
- 不应手动调用GC
- 正则表达式对性能有影响
- 日志输出注意级别
- 资源close可以分开

