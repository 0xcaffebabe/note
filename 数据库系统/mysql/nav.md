# MYSQL

## 索引

### B+ Tree原理

所有叶子节点位于同一层

![批注 2020-03-10 192507](/assets/批注%202020-03-10%20192507.png)

#### 操作

- 查找

首先在根节点进行二分查找，找到一个key的指针，接下来递归地不断向其非叶子节点查找，到了叶子节点，再进行二分查找，找出key所对应的data

- 修改操作会破坏平衡性，所以修改之后会进行分裂、合并、旋转

#### vs红黑树

- 红黑树的出度为2，B树的出度要大很多，所以B树的查找次数更少
- B+ Tree能更好地利用磁盘的预读特性

### MYSQL索引

#### B+ Tree索引

- 是大多数 MySQL 存储引擎的默认索引类型
- 除了用于查找，还可以用于排序和分组
- 适用于全键值、键值范围和键前缀查找

#### 哈希索引

- 无法用于排序与分组
- 只支持精确查找，无法用于部分查找和范围查找

#### 全文索引

- MyISAM 存储引擎支持
- 用于查找文本中的关键词
- 查找条件使用 MATCH AGAINST
- 使用倒排索引

#### 空间数据索引

间数据索引（R-Tree），可以用于地理数据存储

### 索引优化

#### 独立的列

进行查询时，索引列不能是表达式的一部分，也不能是函数的参数

```sql
SELECT a FROM B WHERE a+3 = 6; -- a不能作为索引
```

#### 多列索引

多个列作为条件进行查询时，使用多列索引比使用多个单列索引性能更好

#### 索引列的顺序

让选择性最强的索引列放在前面

一个列比另外一个列更越能确定一条数据，则前者选择性更强

#### 前缀索引

BLOB、TEXT 和 VARCHAR 类型的列，必须使用前缀索引，只索引开始的部分字符

#### 覆盖索引

索引包含所有需要查询的字段的值

- 只读取索引能大大减少数据访问量
- 一些存储引擎只缓存索引

### 索引的优点

- 减少了服务器需要扫描的数据行数
- 帮助服务器避免进行排序和分组，以及避免创建临时表
- 将随机 I/O 变为顺序 I/O

### 索引使用条件

- 小表全表扫描效率优于索引
- 索引适合中大型表
- 特大型表，建立和维护索引的代价将会随之增长

## 用户及权限管理

- 创建一个能在主机登录的用户
  
```sql
create user 'user2'@'%' identified by '123';
```

- 授予权限

```sql
grant all on *.* to 'user2'@'%';
```
  
## 设计规范

### 命名规范

### 数据库

- [a-z ][0-9] _
- 不超过30字符
- 备份数据库可以加自然数

### 表

- [a-z ][0-9] _
- 相同关系的表可以加相同的前缀

### 字段

- [a-z ][0-9] _
- 多个单词使用下划线分割
- 每个表必须有自增主键（默认系统时间）
- 关联字段名尽可能相同

## 字段类型规范

- 使用较少的空间来存储
- ip最好使用int
- 固定长度的类型使用char
- 最好给默认值

## 索引规范

- 加一个index后缀
- 为每个表创建主键索引
- 符合索引慎重

## 范式规范

- 必须满足第二范式
- 尽量满足第三范式

# MYSQL设计原则

## 核心原则

- 不在数据库做运算
- 控制列数量（20以内）
- 平衡范式与冗余
- 禁止大SQL
- 禁止大事务
- 禁止大批量

## 字段原则

- 用好数据类型节约空间
- 字符转为数字
- 避免使用NULL
- 少用text

## 索引原则

- 不在索引列做运算
- innodb主键使用自增
- 不用外键

## SQL原则

- 尽可能简单
- 简单事务
- 避免使用触发器，函数
- 不使用select *
- OR改写成IN或UNION
- 避免前%
- 慎用count（*）
- limit高效分页
- 少用连接join
- group by 
- 使用同类型比较
- 打散批量更新

