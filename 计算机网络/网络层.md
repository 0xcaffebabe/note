# 网络层

网络层是整个互联网的核心，因此应当让网络层尽可能简单。网络层向上只提供简单灵活的、无连接的、尽最大努力交互的数据报服务

IP协议可以将异构的物理网络连接起来，看起来就像是一个统一的网络

- 数据平面：控制数据报从路由器输入链路转发到输出链路
- 控制平面：控制数据在端到端之间的路由方式

## 路由器工作原理

![202036111917](/assets/202036111917.jpg)

### 分组转发流程

![202036112047](/assets/202036112047.jpg)

### 输入

- 线路链接
- 对数据报进行拆封
- 查找转发排队

### 交换

- 通过内存转发
- 通过总线转发
- 通过互联网络转发

前两种在同一时刻内只有一个分组能被处理，最后一种如果输出端口不同，则能并行转发

### 分组调度

- 先进先出
- 优先权排队
  - 即分为两个队列，一个优先级较高，较高优先级的队列如果有分组，则立马处理
- 循环和加权公平排队
  - 优先级队列不固定，在各个队列之间的轮流

## 网际协议

### IP数据报格式

![202036105416](/assets/202036105416.jpg)

### IPV4 

![](https://img-my.csdn.net/uploads/201212/05/1354698013_5018.jpg)

### 分片

由于某些链路的帧可承载的字节有限，故在路由器会将数据载荷分为几个部分，后一一发送，并把组装数据的任务交给接收端

![202036105520](/assets/202036105520.png)

### IPV4编址

#### 分类

由两部分组成，网络号和主机号，其中不同分类具有不同的网络号长度，并且是固定的

![20203610578](/assets/20203610578.png)

#### 子网划分

通过在主机号字段中拿一部分作为子网号，把两级 IP 地址划分为三级 IP 地址

#### 无分类

CIDR 的记法上采用在 IP 地址后面加上网络前缀长度的方法，例如 128.14.35.7/20 表示前 20 位为网络前缀

通过使用网络前缀来减少路由表项的方式称为路由聚合，也称为 构成超网

### 网络地址转换NAT

![202036111610](/assets/202036111610.png)

### IPV6

![](https://huminxi.netlify.com/img/hufei/062018/ipv6-datagram-format.png)

*IPV4到IPV6之间的过渡：建隧道*

![](https://img-blog.csdn.net/20160109165935943)

## 通用转发

- 跨越网络层-链路层

## 路由选择算法

- 集中式
  - 迪杰斯特拉算法得出最短路径
- 分散式
  - 距离向量算法

### 内部网关协议RIP

RIP 按固定的时间间隔仅和相邻路由器交换自己的路由表，经过若干次交换之后，所有路由器最终会知道到达本自治系统中任何一个网络的最短距离和下一跳路由器地址

### 内部网关协议OSPF

自治系统内部的路由选择

- 集中式算法，使用Dijkstra 算法
- 每台路由器都有整个自治系统的完整链路图

### 外部网关协议BGP

自治系统之间的路由选择协议

![202036112459](/assets/202036112459.png)

## SDN控制平面

>软件定义网络（Software Defined Network，SDN）是由美国斯坦福大学CLean State课题研究组提出的一种新型网络创新架构，是网络虚拟化的一种实现方式。其核心技术OpenFlow通过将网络设备的控制面与数据面分离开来，从而实现了网络流量的灵活控制，使网络作为管道变得更加智能，为核心网络及应用的创新提供了良好的平台

### 特征

- 基于流的转发
  - 横跨多个协议层
- 数据平面与控制平面分离
- 网络控制
- 可编程网络

## ICMP

![20203611212](/assets/20203611212.jpg)

- 差错报告
- 询问报文

![20203611344](/assets/20203611344.png)

### ping

Ping 的原理是通过向目的主机发送 ICMP Echo 请求报文，目的主机收到之后会发送 Echo 回答报文

### traceroute

发送的 IP 数据报封装的是无法交付的 UDP 用户数据报，并由目的主机发送终点不可达差错报告报文

当TTL为0时，路由器将不会继续转发报文，traceroute通过第一次将TTL设为1，然后把报文发送给下一台路由器，路由器将ttl-1之后告诉主机报文不可达，这样以此类推得到整个路由链路

## SNMP

- 简单网络管理协议
  - 一般使用UDP

## 虚拟专用网VPN

![20203611147](/assets/20203611147.jpg)