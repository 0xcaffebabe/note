# 运输层

- 运输层的功能：为不同主机上的进程提供逻辑通信 

**运输层与网络层的关系**：网络层为运输层提供服务，运输层构建在网络层之上

## 运输层协议

- TCP
- UDP

运输层通过Socket端口来实现多路复用与多路分解

## UDP

- 对发送时间以及发送内容控制能力更强
- 无连接
- 无状态
- 分组首部小
- 支持一对一、一对多、多对一和多对多的交互通信

### UDP首部

![2020379295](/assets/2020379295.jpg)

## TCP

面向连接的，提供可靠交付，有流量控制，拥塞控制，提供全双工通信，面向字节流，每一条 TCP 连接只能是点对点的

### TCP首部

![20203793059](/assets/20203793059.png)

序号：对字节流进行编号，序号为 301，表示第一个字节的编号为 301，如果携带的数据长度为 100 字节，那么下一个报文段的序号应为 401

确认号：期望收到的下一个报文段的序号，例如 B 正确收到 A 发送来的一个报文段，序号为 501，携带的数据长度为 200 字节，因此 B 期望下一个报文段的序号为 701

数据偏移：也就是首部的长度

RST/SYN/FIN 用于连接的建立与拆除
URG 代表是上层紧急数据
ACK 确认
PSH 尽快交给应用层

窗口：窗口值作为接收方让发送方设置其发送窗口的依据

### RTT 估计

一个报文段从发送再到接收到确认所经过的时间称为往返时间 RTT

```java
均值RTT = 0.875 * 均值RTT + 0.125 * 样本RTT
```

### 可靠数据传输

![20203795214](/assets/20203795214.png)

### 滑动窗口

![2020379557](/assets/2020379557.jpg)

### 流量控制

接收方通过在报文段中添加接口窗口字段来进行双方之间的速度匹配
接收方发送的确认报文中的窗口字段可以用来控制发送方窗口大小，从而影响发送方的发送速率。将窗口字段设置为 0，则发送方不能发送数据

### 连接管理

#### 三次握手

![20203793532](/assets/20203793532.png)

如果只使用两次握手，请求很有可能在网络中滞留，而客户端因为超时重新请求连接，而发起新的请求，先前的请求对于客户端来说已经失效
第三次握手是为了防止失效的连接请求到达服务器，让服务器错误打开连接

#### 四次挥手

![20203794049](/assets/20203794049.jpg)

客户端发起一个关闭连接的请求，服务器响应这个关闭请求
此时，客户端不能再向服务端发送数据，但是服务器可以发送数据给客户端，当服务器的数据传送完毕，向客户端发送一个关闭连接的请求
客户端接收到服务端的关闭请求后，再发送一个确认消息，等待2MSL的时间，关闭
服务端接收到客户端的最后一个关闭请求后，关闭

等待2MSL时间是为了让本连接持续时间内所产生的所有报文都从网络中消失，使得下一个新的连接不会出现旧的连接请求报文

### 拥塞控制

#### 原则

- 报文段丢失时发送方降低速率
- 未确认报文段确认到达时，发送方增加速率
- 带宽探测

#### 慢启动

![20203795753](/assets/20203795753.jpg)

不断增加直到超时，超时后将cwnd/2

#### 快重传与快恢复

![20203710029](/assets/20203710029.png)

### 公平性

UDP源有可能压制TCP流量

- 明确拥塞通知：由路由器在报文中插入当前路由器的拥塞情况