{"name":"流量控制","id":"软件工程-架构-系统设计-流量控制","content":"# 流量控制\n\n## 1. 概述（Overview）\n\n流量控制（Traffic Control）是一套用于确保系统在有限资源约束下保持稳定、高可用、可预测运行的治理体系。\n它通过在不同层次对流量进行识别、度量、限制和削峰，实现 **资源保护、防止过载、削峰填谷、平滑突发流量、保障核心业务稳定** 等目标。\n\n流量控制不是单一技术，而是一套 **从策略 → 流量模型 → 算法 → 分层限流 → 治理体系** 的完整系统。\n\n---\n\n## 2. 流量控制的本质（Essence）\n\n流量控制的核心矛盾：\n\n> **系统资源有限**\n> VS\n> **访问流量不可控且可能波动极大**\n\n因此需要建立一个能在资源逼近极限时进行自动管控的体系，使得系统在高压场景下仍能 **提供可预测、稳定、可退化的服务能力**。\n\n其本质包括：\n\n* **资源保护**：保护 CPU、内存、线程池、数据库连接等稀缺资源\n* **服务能力匹配**：使下游能力与上游流量匹配\n* **风控与业务保护**：避免因为突发流量导致全局性故障\n* **系统容错能力**：通过拒绝、降级、排队等方式避免系统雪崩\n* **服务质量治理**：防止个别接口抢占过多资源\n\n---\n\n## 3. 流量控制能力模型（Capability Model）\n\n一个完整的流量控制体系至少包含以下模块：\n\n### **3.1 流量画像（Traffic Profiling）**\n\n* 流量分布（分钟级/秒级/突发情况）\n* 访问类型（读、写、热点、背景任务）\n* 调用链路影响范围\n\n### **3.2 指标体系（Metrics System）**\n\n系统能力边界依赖关键指标，包括：\n\n* **TPS（事务数/秒）**\n* **HPS（请求数/秒）**\n* **QPS（查询数/秒）**\n* 延迟 P99/P95/P90\n* 最大并发数\n* IO 带宽、网络带宽\n\n不同业务还存在自定义指标：\n如游戏的在线人数、IO 服务的最大带宽等。\n\n### **3.3 控制策略（Control Policies）**\n\n* 固定限流（静态阈值）\n* 动态限流（根据RT、错误率、拥塞情况实时调整）\n* 排队/柔性限流（非快速失败）\n* 业务层面限流（库存、抽奖次数、秒杀总量）\n\n### **3.4 分层限流体系（Layered Control）**\n\n**最关键的系统性原则：不信任上层限流**\n\n* **前端**：柔性限流、随机延时、熔断部分请求\n* **网关层**：统一限流策略、访问频控、IP 限制\n* **应用层**：接口级限流、线程池限流\n* **下游层**：DB、缓存、RPC 下游保护\n\n分层限流的目标：\n\n> 避免某一层限流失效导致全局崩溃\n\n---\n\n## 4. 流量承载能力与水位模型（Capacity & Waterline）\n\n系统承载能力必须通过：\n\n* **全链路压测**\n* **历史高峰数据**\n* **资源评估（CPU、线程、连接池、IO）**\n\n确定两类水位：\n\n* **安全水位**：系统在稳定范围可承载的流量\n* **极限水位**：系统在极端情况下能承受的最大极限\n\n过低浪费资源，过高会导致雪崩。\n\n---\n\n## 5. 流量控制核心技术模型（Algorithms & Models）\n\n### 5.1 计数器算法（Counter）\n\n**原理**：维护一个当前活动请求数计数器，超过阈值即限流。\n典型实现：线程池大小、数据库连接池大小、Nginx worker limit。\n\n#### 固定时间窗计数\n\n![固定时间窗](/assets/屏幕截图%202022-05-09%20170123.png)\n\n问题：在窗口切换的边界点可能出现突发流量未被限制。\n\n#### 滑动窗口计数\n\n![滑动窗口](/assets/202001271051.jpg)\n\n更精确，按前 N 时间片累计请求数判断。\n\n---\n\n### 5.2 队列限流（Queue / FIFO）\n\n（参考：/软件工程/性能工程.md#排队论）\n\n所有请求入队，由后端消费端按能力处理。\n可扩展：\n\n* 多队列多优先级\n* 加入最长期限（避免过长等待）\n* 排队超时快速失败\n\n---\n\n### 5.3 漏桶算法（Leaky Bucket）\n\n![202001271537](/assets/202001271537.png)\n\n**本质：限制处理速率（Rate）**\n\n* 入桶不限速\n* 出桶以固定速率处理\n* 桶满则丢弃流量\n\n适合：**瞬时高并发，希望处理更平滑** 的场景。\n\n---\n\n### 5.4 令牌桶算法（Token Bucket）\n\n![2020789425](/assets/20207894250)\n\n**本质：限制平均速率 + 允许突发流量**\n\n* 固定速率向桶中增加令牌\n* 请求需要消耗令牌\n* 允许桶中积累一定额度 → 支持突发\n\nGuava 示例保留（略）\n\n---\n\n### 5.5 动态限流（Adaptive Throttling）\n\n借鉴 TCP 拥塞控制。\n\n方法：\n\n1. 统计 RT P99/P95\n2. RT 超出阈值 → 自动下降阈值（如降为 ½）\n3. RT 恢复 → 逐步增加阈值\n\n用于构建：\n\n* 自动调参型限流系统\n* 高频量变化系统\n\n---\n\n## 6. 分布式限流模型（Distributed Throttling）\n\n### **6.1 单机限流（Local）**\n\n按节点均分配额，在各节点执行限流。\n动态调整配额 → 防止流量倾斜。\n\n### **6.2 全局限流（Global）**\n\n一个集中式限流服务负责发放配额：\n\n* 本地缓存兜底策略\n* 限流服务器异常时 fallback\n* 同时支持开关控制\n\n### **6.3 货币令牌（Quota Token）**\n\n请求链路携带额度 token：\n\n* 每调用一次减少额度\n* 额度耗尽时停止或向中心申请新额度\n* 多系统协同限流效果最佳\n\n---\n\n## 7. 流量切换与扩展（Traffic Switching & Scaling）\n\n### 7.1 扩展（Scaling）\n\n上游扩容 → 下游必须同步扩展\n避免 “上游把下游打死” 的情况。\n\n### 7.2 流量切换（Traffic Switching）\n\n* **DNS**\n* **虚拟 IP（VIP）**\n* **应用层（Nginx / 网关）**\n\n用于蓝绿、灰度、金丝雀发布。\n\n---\n\n## 8. 超额流量处理策略（Overflow Strategies）\n\n系统接近极限时必须采取：\n\n### 8.1 快速失败（Fail Fast）\n\n减少资源浪费。\n\n### 8.2 排队（Queue）\n\n等待资源恢复。\n\n### 8.3 柔性限流（Soft Throttling）\n\n用户不明显感知：\n\n* 随机延迟再发起请求\n* 某些次要请求随机丢弃\n* 前端本地缓存/去抖\n\n### 8.4 降级（Degrade）\n\n* 降级非核心接口\n* 返回默认值\n* 限制写操作\n* 去掉昂贵查询\n\n---\n\n## 9. 限流阈值确定（Threshold Design）\n\n确定限流阈值四种途径：\n\n1. **历史观测**：根据业务高峰 QPS\n2. **压测**：最可靠，确定能力边界\n3. **经验借鉴**：适用于行业标准业务\n4. **资源计算**：CPU/线程/IO 理论最大承载与业务模型计算\n\n---\n\n## 10. 流量控制治理体系（Governance System）\n\n### 10.1 可观测性（Observability）\n\n必须监控：\n\n* QPS/HPS/TPS\n* RT（P90/P99）\n* 线程池队列长度\n* DB/Redis 连接池使用率\n* 限流次数、拒绝比率\n* 下游依赖健康度\n\n### 10.2 演进方式（Evolution）\n\n* 静态 → 动态限流\n* 单节点 → 分布式限流\n* 被动限流 → 主动预测限流\n* IP 限流 → 用户画像限流（AI Risk Control）\n\n### 10.3 选型方法论\n\n按场景选择：\n\n| 场景      | 推荐算法        |\n| ------- | ----------- |\n| 强一致速率控制 | 漏桶          |\n| 允许突发    | 令牌桶         |\n| 并发控制    | 计数器         |\n| 可排队任务   | FIFO 队列     |\n| 高频波动业务  | 动态限流        |\n| 分布式架构   | 全局限流 / 货币令牌 |\n\n## 关联内容（自动生成）\n\n- [/软件工程/架构/系统设计/可用性.md](/软件工程/架构/系统设计/可用性.md) 流量控制与可用性密切相关，包括限流、降级、熔断等策略保障系统可用性\n- [/软件工程/微服务/服务治理/服务容错.md](/软件工程/微服务/服务治理/服务容错.md) 服务容错机制涵盖流量控制中的熔断、限流、降级等策略，是保障系统稳定的重要手段\n- [/软件工程/架构/系统设计/网关.md](/软件工程/架构/系统设计/网关.md) 网关承担着流量控制的重要职能，实现统一限流策略、访问频控等功能\n- [/软件工程/软件设计/代码质量/软件测试/全链路压测.md](/软件工程/软件设计/代码质量/软件测试/全链路压测.md) 全链路压测是确定流量控制阈值的重要手段，通过压测可确定系统安全水位和极限水位\n- [/软件工程/架构/系统设计/伸缩性.md](/软件工程/架构/系统设计/伸缩性.md) 伸缩性与流量控制相互配合，通过指标监控和自动化扩缩容应对流量变化\n- [/软件工程/质量工程.md](/软件工程/质量工程.md) 质量工程包含流量控制相关的性能保障措施，如全链路压测、混沌工程等\n- [/软件工程/架构/系统设计/监控系统设计.md](/软件工程/架构/系统设计/监控系统设计.md) 监控系统是流量控制的重要支撑，提供QPS、TPS等关键指标监控\n- [/软件工程/容量保障.md](/软件工程/容量保障.md) 容量保障与流量控制密切相关，通过QPS、TPS等指标确定系统容量和限流阈值\n- [/软件工程/架构/系统设计/高并发.md](/软件工程/架构/系统设计/高并发.md) 高并发系统设计中需要综合运用流量控制的各种算法和策略\n- [/软件工程/架构/系统设计/缓存.md](/软件工程/架构/系统设计/缓存.md) 缓存与流量控制同为系统保护手段，可减轻后端服务压力，缓解流量冲击\n- [/计算机网络/运输层.md](/计算机网络/运输层.md) 运输层的流量控制机制（滑动窗口）与应用层流量控制在原理上相通\n- [/软件工程/架构/架构治理.md](/软件工程/架构/架构治理.md) 架构治理包含了流量控制等非功能性需求的治理和规范\n- [/编程语言/JAVA/JAVA并发编程/线程池.md](/编程语言/JAVA/JAVA并发编程/线程池.md) 线程池是流量控制在单机层面的重要实现，通过限制并发数控制流量\n- [/中间件/数据库/分库分表中间件.md](/中间件/数据库/分库分表中间件.md) 数据库中间件的限流功能是流量控制在数据访问层面的具体应用\n- [/软件工程/架构/系统设计/混沌工程.md](/软件工程/架构/系统设计/混沌工程.md) 混沌工程可验证流量控制策略在异常场景下的有效性\n- [/计算机网络/多媒体网络.md](/计算机网络/多媒体网络.md) 多媒体网络中的漏桶机制与流量控制中的漏桶算法原理一致，用于动态管控流量\n- [/软件工程/性能工程.md](/软件工程/性能工程.md) 性能工程涉及流量控制相关的性能指标和排队论原理\n","metadata":"tags: ['运维', '计算机系统', '性能']","hasMoreCommit":true,"totalCommits":13,"commitList":[{"date":"2026-02-12T14:07:03+08:00","author":"MY","message":"doc: 整理标签","hash":"290b3e8ad18f48832ac282290238d020fc030a88"},{"date":"2025-11-25T19:26:55+08:00","author":"MY","message":"docs(traffic-control): 更新流量控制文档内容与结构","hash":"875aa8f9f318acc8a39e812607dde377985ce106"},{"date":"2024-12-13T17:26:53+08:00","author":"MY","message":"✏流控","hash":"ddde74525a5e1796cd5e8b5c95c61a609c927d94"},{"date":"2024-11-21T19:38:10+08:00","author":"MY","message":"📦流控 & 缓存","hash":"ec18717ffca6c3c8867ce0cf6bbbeff241c19ff8"},{"date":"2023-09-18T15:54:54+08:00","author":"MY","message":"✏流量控制","hash":"62c6662566295a5342aa45061bba8c7a807f449b"},{"date":"2023-01-16T16:58:46+08:00","author":"cjiping","message":"✏️限流","hash":"93acb4cc071ea230f180076cedd00d5c713e9d50"},{"date":"2022-07-15T17:06:40+08:00","author":"cjiping","message":"✏️更新 流量控制","hash":"4f0d5e724a36dfcf422a165896c9ec98010a3e98"},{"date":"2022-05-09T17:46:13+08:00","author":"cjiping","message":"✏️更新 可用性","hash":"f68313ea1ba47cd7a335d34d32466b17c04f15e9"},{"date":"2022-01-16T16:18:31+08:00","author":"MY","message":"✏️更新 分布式相关","hash":"0c267fb25c7fd1f2a3536cab5c979b0c3bf90b6d"},{"date":"2021-11-09T14:51:50+08:00","author":"cjiping","message":"✏流量控制添加标签","hash":"95ca11c44eada8b149788bed3affcc3661425921"}],"createTime":"2020-11-20T15:17:06+08:00"}