{"name":"防御式编程","id":"软件工程-软件设计-代码质量-防御式编程","content":"# 防御式编程\n\n## 概述（Overview）\n防御式编程（Defensive Programming）是一种软件设计哲学，旨在增强程序的**鲁棒性、可靠性和可维护性**。其核心目标是防止系统因不可信输入、异常状态或不可预知事件而崩溃，同时在保证正确性的前提下提供可恢复能力。\n\n防御式编程不仅是单一编码技巧，而是**从输入验证、状态保护、运行时防护到自恢复治理的系统化方法论**。\n\n---\n\n## 防御式编程四层模型\n\n| 层级 | 核心内容 | 工程实践示例 |\n|------|---------|--------------|\n| 输入验证层 | 清洗、校验外部不可信数据 | DTO 校验、Schema 检查、边界值验证 |\n| 状态防御层 | 维护对象不变量、逻辑前置条件 | assert、invariant check、断言 |\n| 运行时防护层 | 错误处理、异常传播、降级策略 | try-catch、重试机制、Fallback、Circuit Breaker |\n| 自恢复与治理层 | 日志、监控、统一异常处理、自动恢复 | 结构化日志、SLO、探针、告警、熔断 |\n\n> 通过此四层模型，防御式编程从**概念、代码到运维**形成闭环，提高系统健壮性与可观测性。\n\n---\n\n## 核心策略与方法\n\n### 1. 输入验证（Validation）\n- **目标**：隔离不可信数据，防止污染内部逻辑。\n- **常用方法**：\n  - 字段类型和边界检查\n  - 格式校验（正则、schema）\n  - 业务规则验证\n- **设计原则**：\n  - 不可信输入一律验证\n  - 验证结果明确记录（日志/监控）\n\n**示例：**\n\n```java\nif (userAge < 0 || userAge > 150) {\n    throw new IllegalArgumentException(\"Invalid user age: \" + userAge);\n}\n```\n\n---\n\n### 2. 状态防御（State Defense）\n- **目标**：保证对象与系统状态的一致性。\n- **核心工具**：\n  - 断言（assert）\n  - 不变量检查（invariant）\n- **注意事项**：\n  - 避免将业务逻辑嵌入断言\n  - 开发环境启用，生产环境根据需求选择性启用\n\n**示例：**\n\n```java\nassert a != 0 : \"a cannot be zero\";\n```\n\n> 断言用于捕获绝对不可能出现的状态，生产环境可以关闭以减少性能损耗。\n\n---\n\n### 3. 运行时防护（Error Handling & Exceptions）\n- **目标**：在错误发生时，提供可控的响应策略。\n- **策略分类**：\n\n| 错误类型 | 推荐处理方式 | 注意事项 |\n|-----------|------------|----------|\n| 可修复数据错误 | 使用默认值、最近正确数据、最接近合法值 | 仅在不会影响业务正确性 |\n| 临时系统错误 | 重试机制、延迟重试 | 避免无限循环 |\n| 不可恢复错误 | 抛异常、Fail-fast、停止程序 | 保证程序安全性 |\n\n- **异常处理原则**：\n  - 异常必须携带完整上下文信息\n  - 禁止空 catch\n  - 对未捕获异常使用统一处理机制\n  - 配合日志与监控进行治理\n\n**示例：**\n\n```java\ntry {\n    processData(data);\n} catch (DataFormatException e) {\n    log.error(\"Invalid data format\", e);\n    throw e; // 或进行降级处理\n}\n```\n\n---\n\n### 4. 程序隔离（Program Isolation）\n- **目标**：将不可信组件与核心业务逻辑隔离，减少传播风险。\n- **实现模式**：\n  - 数据验证层（Validation Layer）\n  - DTO/VO 与内部模型分离\n  - 边界防护（Boundary Objects / Anti-Corruption Layer）\n\n**示例架构图（Mermaid）**：\n\n```mermaid\nflowchart LR\n    subgraph External[\"外部数据来源（不可信）\"]\n        UI[\"用户界面\"]\n        CLI[\"命令行\"]\n        Realtime[\"实时数据采集\"]\n        Files[\"外部文件\"]\n    end\n\n    subgraph Validation[\"数据验证层\"]\n        V1[\"验证类1\"]\n        V2[\"验证类2\"]\n        V3[\"验证类3\"]\n    end\n\n    subgraph Internal[\"内部逻辑层（可信数据）\"]\n        C1[\"核心业务模块1\"]\n        C2[\"核心业务模块2\"]\n        C3[\"核心业务模块3\"]\n    end\n\n    UI --> V1\n    CLI --> V1\n    Realtime --> V2\n    Files --> V3\n\n    V1 --> Internal\n    V2 --> Internal\n    V3 --> Internal\n```\n\n---\n\n### 5. 自恢复与辅助治理\n- **目标**：在生产环境中尽量自动恢复，减少人工干预。\n- **实践方法**：\n  - 开发环境增加 fail-fast 测试逻辑\n  - 生产环境保证错误可自恢复\n  - 日志、监控、告警配合防御策略\n- **原则**：\n  1. 保留关键检查\n  2. 尽量避免阻塞或崩溃\n\n---\n\n### 6. 防御与性能的平衡\n- **原则**：\n  - 保留检查重要错误的代码\n  - 避免过度防御导致性能和复杂度增加\n  - 静态分析、类型系统、合约式编程可减少运行时检查需求\n\n---\n\n## 防御式编程现代趋势\n- **云原生与自动恢复**：\n  - 利用探针、自动重启、熔断机制实现自愈\n- **类型系统与静态分析**：\n  - Null safety、不可变对象、合约式检查\n- **可观测性驱动的防御**：\n  - 指标监控、告警策略\n  - 错误发生频率与影响范围分析\n- **契约与合约式接口**：\n  - OpenAPI、GraphQL schema 提前约束输入输出\n\n---\n\n## 总结\n防御式编程是一种**从概念到工程实践的系统化方法论**。通过四层模型、错误分类、程序隔离和治理机制，可以在保证正确性与鲁棒性的同时，降低复杂度和运行风险。现代系统趋势强调可观测性、自动恢复和静态分析，使防御式编程不仅是编码技巧，更是**软件设计与运维的完整体系**。\n\n## 关联内容（自动生成）\n\n- [/软件工程/架构/系统设计/可观测性.md](/软件工程/架构/系统设计/可观测性.md) - 可观测性是防御式编程的重要组成部分，特别是自恢复与治理层中的监控、日志、告警等实践，与防御式编程的第四层模型紧密相关\n- [/编程语言/JAVA/高级/异常.md](/编程语言/JAVA/高级/异常.md) - 详细阐述了Java异常体系，与防御式编程中运行时防护层的异常处理策略密切相关，包括异常分类、性能开销、系统设计中的异常处理等内容\n- [/软件工程/微服务/服务治理/服务容错.md](/软件工程/微服务/服务治理/服务容错.md) - 涵盖了防御式编程中运行时防护层的关键技术，包括断路器模式、舱壁隔离、重试机制、熔断降级等策略，是防御式编程在分布式系统中的具体实现\n- [/软件工程/架构/系统设计/可用性.md](/软件工程/架构/系统设计/可用性.md) - 涵盖了熔断、降级、限流等与防御式编程运行时防护层相关的技术，以及系统可用性保障的完整体系\n- [/软件工程/领域驱动设计.md](/软件工程/领域驱动设计.md) - 包含了防腐层（Anti-Corruption Layer）概念，与防御式编程中程序隔离的边界防护模式密切相关，用于隔离外部不可信模型对内部系统的影响\n- [/软件工程/软件设计/代码质量/防错设计.md](/软件工程/软件设计/代码质量/防错设计.md) - 与防御式编程相辅相成的设计理念，都关注系统的健壮性和错误处理，防错设计更侧重于预防错误的发生\n- [/软件工程/架构/Web前端/前后端分离.md](/软件工程/架构/Web前端/前后端分离.md) - 涉及前后端双层输入验证，与防御式编程的输入验证层直接相关\n- [/计算机网络/网络安全/Web安全.md](/计算机网络/网络安全/Web安全.md) - 涵盖输入验证安全，与防御式编程中输入验证层的安全考虑密切相关\n- [/软件工程/软件设计/代码质量/编码规范.md](/软件工程/软件设计/代码质量/编码规范.md) - 包含异常处理和日志规范，是防御式编程实施的重要指导\n- [/软件工程/架构/系统设计/网关.md](/软件工程/架构/系统设计/网关.md) - 网关作为系统入口，承担着输入验证、熔断、重试等防御式编程的关键职责\n","metadata":"tags: ['软件工程', '计算机系统']","hasMoreCommit":false,"totalCommits":3,"commitList":[{"date":"2026-02-12T14:07:03+08:00","author":"MY","message":"doc: 整理标签","hash":"290b3e8ad18f48832ac282290238d020fc030a88"},{"date":"2025-11-20T17:33:21+08:00","author":"MY","message":"docs(architecture): 完善防御式编程文档内容","hash":"b04c33dbc72c5fc69f7d27670ffe3c6bc6bd5a8d"},{"date":"2021-09-22T17:01:14+08:00","author":"cjiping","message":"➕新增 防御式编程","hash":"93279317eb857cff16bf52d4879d57058f1ceb78"}],"createTime":"2021-09-22T17:01:14+08:00"}